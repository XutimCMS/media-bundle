{% extends '@XutimCore/admin/base.html.twig' %}
{% import '@XutimCore/admin/common/translatable.html.twig' as translatable %}

{% block pageTitle %}
    <h1 class="page-title">
        {% if translation %}
            {{ translation.name }}
        {% else %}
            {{ media.originalPath|split('/')|last }}
        {% endif %}
    </h1>
{% endblock %}

{% block languageBar %}
    <twig:Xutim:Admin:LanguageContextBar
        :entity="media"
        :simpleTranslation="true"
        class="d-flex justify-content-end align-items-center mb-2"
    />
{% endblock %}

{% block sidebar %}
    <twig:Xutim:Admin:Sidebar :title="">
        <twig:block name="header">
            <twig:Xutim:Admin:SidebarTabs>
                <twig:Xutim:Admin:SidebarTab target="general-tab">
                    <twig:Xutim:Admin:Button
                        variant="tab"
                        type="a"
                        class="active"
                        data-bs-toggle="tab"
                        href="#general-tab"
                        role="tab"
                        aria-controls="general-tab"
                        aria-selected="true"
                    >
                        General
                    </twig:Xutim:Admin:Button>
                </twig:Xutim:Admin:SidebarTab>
            </twig:Xutim:Admin:SidebarTabs>
        </twig:block>
        <twig:block name="content">
            <div class="tab-content">
                <div id="general-tab" class="tab-pane active" role="tabpanel">
                    <div class="mb-3">
                        <twig:Xutim:Admin:SidebarSection>
                            <twig:Xutim:Admin:SidebarItem id="media-copyright-sidebar-item">
                                <twig:block name="header">
                                    {{ 'copyright'|trans({}, 'admin')|capitalize }}:
                                </twig:block>
                                <twig:block name="content">
                                    {{ media.copyright ?? '-' }}

                                    <div class="btn-group float-end">
                                        <twig:Xutim:Admin:Button
                                            tag="a"
                                            variant="link"
                                            class="p-0"
                                            data-turbo-frame="modal"
                                            href="{{ admin_path('admin_media_copyright_edit', {id: media.id}) }}"
                                        >
                                            <twig:Xutim:Admin:Icon name="edit" />
                                        </twig:Xutim:Admin:Button>
                                    </div>
                                </twig:block>
                            </twig:Xutim:Admin:SidebarItem>
                        </twig:Xutim:Admin:SidebarSection>
                        <twig:Xutim:Admin:SidebarSection>
                            <twig:Xutim:Admin:SidebarHeader>
                                {{ 'original file'|trans({}, 'admin')|capitalize }}
                            </twig:Xutim:Admin:SidebarHeader>
                            <twig:Xutim:Admin:SidebarItem>
                                <twig:block name="header">
                                    {{ 'file size'|trans({}, 'admin')|capitalize }}:
                                </twig:block>
                                <twig:block name="content">
                                    {{ (media.sizeBytes / 1024)|round(0) }} KB
                                </twig:block>
                            </twig:Xutim:Admin:SidebarItem>
                            <twig:Xutim:Admin:SidebarItem>
                                <twig:block name="header">
                                    {{ 'image dimensions'|trans({}, 'admin')|capitalize }}:
                                </twig:block>
                                <twig:block name="content">
                                    {{ media.width }} × {{ media.height }}
                                </twig:block>
                            </twig:Xutim:Admin:SidebarItem>
                            <twig:Xutim:Admin:SidebarItem>
                                <twig:block name="header">
                                    {{ 'format'|trans({}, 'admin')|capitalize }}:
                                </twig:block>
                                <twig:block name="content">
                                    {{ media.originalExt|upper }}
                                </twig:block>
                            </twig:Xutim:Admin:SidebarItem>
                            <twig:Xutim:Admin:SidebarItem id="media-focal-point-sidebar-item">
                                <twig:block name="header">
                                    {{ 'Focal Point'|trans({}, 'admin') }}:
                                </twig:block>
                                <twig:block name="content">
                                    {% if media.focalX and media.focalY %}
                                        {{ media.focalX|number_format(2) }}, {{ media.focalY|number_format(2) }}
                                    {% else %}
                                        {{ 'Center (default)'|trans({}, 'admin') }}
                                    {% endif %}

                                    {% if media.isImage %}
                                        <div class="btn-group float-end">
                                            <twig:Xutim:Admin:Button
                                                tag="a"
                                                variant="link"
                                                class="p-0"
                                                data-turbo-frame="modal"
                                                href="{{ admin_path('admin_media_focal_point_edit', {id: media.id}) }}"
                                            >
                                                <twig:Xutim:Admin:Icon name="edit" />
                                            </twig:Xutim:Admin:Button>
                                        </div>
                                    {% endif %}
                                </twig:block>
                            </twig:Xutim:Admin:SidebarItem>
                            {% if media.folder %}
                                <twig:Xutim:Admin:SidebarItem>
                                    <twig:block name="header">
                                        {{ 'folder'|trans({}, 'admin')|capitalize }}:
                                    </twig:block>
                                    <twig:block name="content">
                                        {{ media.folder.name }}
                                    </twig:block>
                                </twig:Xutim:Admin:SidebarItem>
                            {% endif %}
                            <twig:Xutim:Admin:SidebarItem>
                                <twig:block name="content">
                                    <twig:Xutim:Admin:Button
                                        class="btn-link clipboard-input d-flex justify-content-start"
                                        variant="default"
                                        data-controller="clipboard"
                                        data-clipboard-text="/media/{{ media.originalPath }}"
                                        data-bs-toggle="popover"
                                        data-bs-container="body"
                                        data-bs-placement="top"
                                        data-bs-content="{{ 'message.copied'|trans|capitalize }}!"
                                    >
                                        {{ 'copy link to the original file'|trans({}, 'admin')|capitalize }}
                                    </twig:Xutim:Admin:Button>
                                </twig:block>
                            </twig:Xutim:Admin:SidebarItem>
                            <twig:Xutim:Admin:SidebarItem>
                                <twig:block name="content">
                                    <twig:Xutim:Admin:Button
                                        tag="a"
                                        class="btn-link d-flex justify-content-start"
                                        variant="default"
                                        data-turbo-frame="modal"
                                        href="{{ admin_path('admin_media_replace', {id: media.id}) }}"
                                    >
                                        <twig:ux:icon name="tabler:upload" class="w-4 h-4" /> {{ 'replace file'|trans({}, 'admin')|capitalize }}
                                    </twig:Xutim:Admin:Button>
                                </twig:block>
                            </twig:Xutim:Admin:SidebarItem>
                        </twig:Xutim:Admin:SidebarSection>
                    </div>
                </div>
            </div>
        </twig:block>
    </twig:Xutim:Admin:Sidebar>
{% endblock %}

{% block breadcrumbHeader %}
    <twig:Xutim:Admin:Breadcrumbs>
        <li class="breadcrumb-item">
            <a href="{{ admin_path('admin_media_list') }}">{{ 'Media'|trans({}, 'admin') }}</a>
        </li>
        <li class="breadcrumb-item active">
            {% if translation %}
                {{ translation.name }}
            {% else %}
                {{ media.originalPath|split('/')|last }}
            {% endif %}
        </li>
    </twig:Xutim:Admin:Breadcrumbs>
{% endblock %}

{% block pageMenu %}
    <twig:Xutim:Admin:Button
        tag="button"
        id="sidebar-toggle"
        variant="nav"
    >
        <twig:Xutim:Admin:Icon name="layout-sidebar-right" class="me-1" />
        Sidebar
    </twig:Xutim:Admin:Button>
{% endblock %}

{% block body %}
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 d-flex align-items-center justify-content-center">
                    <div class="media-container d-flex justify-content-center align-items-center">
                        {% if media.isImage %}
                            <a
                                href="{{ admin_path('admin_media_focal_point_edit', {id: media.id}) }}"
                                data-turbo-frame="modal"
                                class="btn-link"
                            >
                                <twig:XutimMedia:Admin:Picture
                                    :media="media"
                                    preset="thumb_large"
                                    alt=""
                                    class="p-1"
                                    style="max-width: 300px; max-height: 300px"
                                />
                            </a>
                        {% else %}
                            <button
                                data-lightbox-url-value="/media/{{ media.originalPath }}"
                                data-controller="lightbox"
                                data-action="click->lightbox#open"
                                class="btn-link"
                            >
                                <twig:XutimMedia:Admin:Picture
                                    :media="media"
                                    preset="thumb_large"
                                    alt=""
                                    class="p-1"
                                    style="max-width: 300px; max-height: 300px"
                                />
                            </button>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card-body">
                        {{ form_start(form, {attr: {'data-turbo-action': 'advanced'}}) }}
                        {{ form_row(form.name) }}
                        {{ form_row(form.alt) }}
                        {{ form_row(form.submit) }}
                        {{ form_end(form) }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if media.isImage %}
        <div class="card"
             data-controller="xutim-media--regenerate-variants"
             data-xutim-media--regenerate-variants-regenerate-url-value="{{ admin_path('admin_media_regenerate_variants', {id: media.id}) }}"
             data-xutim-media--regenerate-variants-mercure-topic-value="{{ mercure('media/' ~ media.id ~ '/variants', { subscribe: 'media/' ~ media.id ~ '/variants' }) }}"
        >
            <div class="card-header d-flex align-items-center">
                <span class="h3 mb-0">{{ 'Generated image sizes'|trans({}, 'admin') }}</span>
                <span data-xutim-media--regenerate-variants-target="progress"
                      class="text-muted small ms-2 d-none"></span>
                <button data-action="xutim-media--regenerate-variants#regenerate"
                        data-xutim-media--regenerate-variants-target="button"
                        class="btn btn-sm btn-outline-primary ms-auto"
                        type="button">
                    {{ 'Regenerate'|trans({}, 'admin') }}
                </button>
            </div>
            <div class="card-body p-0">
                <div class="accordion accordion-flush" id="presetAccordion">
                    {% for data in previewData %}
                        <div class="accordion-item">
                            <div class="accordion-header">
                                <button
                                    class="accordion-button collapsed py-2 px-3"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#preset-{{ data.preset.name }}"
                                    aria-expanded="false"
                                    aria-controls="preset-{{ data.preset.name }}"
                                    style="font-size: inherit;"
                                >
                                    <div class="d-flex align-items-center w-100 gap-3">
                                        <strong class="me-auto">{{ data.preset.name }}</strong>
                                        <span class="text-muted small">{{ data.preset.maxWidth }}×{{ data.preset.maxHeight }}</span>
                                        <span class="badge bg-green-lt">{{ data.preset.fitMode.value }}</span>
                                        <span class="text-muted small">{% for fmt, q in data.preset.quality %}{{ fmt }} {{ q }}{% if not loop.last %}, {% endif %}{% endfor %}</span>
                                        {% if data.variants is empty %}
                                            <span class="badge bg-warning text-white" data-preset-badge="{{ data.preset.name }}">{{ 'Not generated'|trans({}, 'admin') }}</span>
                                        {% else %}
                                            <span class="badge bg-success text-white" data-preset-badge="{{ data.preset.name }}">{{ data.variants|length }} {{ 'variants'|trans({}, 'admin') }}</span>
                                        {% endif %}
                                    </div>
                                </button>
                            </div>
                            <div
                                id="preset-{{ data.preset.name }}"
                                class="accordion-collapse collapse"
                                data-bs-parent="#presetAccordion"
                            >
                                <div class="accordion-body">
                                    {% if data.variants is empty %}
                                        <div class="text-muted">{{ 'No variants generated for this preset.'|trans({}, 'admin') }}</div>
                                    {% else %}
                                        {% set webpVariants = data.variants|filter(v => v.variant.format == 'webp') %}
                                        <div class="row g-3">
                                            {% for variantData in webpVariants %}
                                                <div class="col-auto">
                                                    <div class="card">
                                                        <button
                                                            data-lightbox-url-value="{{ variantData.url }}"
                                                            data-controller="lightbox"
                                                            data-action="click->lightbox#open"
                                                            class="btn-link p-0"
                                                        >
                                                            <img
                                                                src="{{ variantData.url }}"
                                                                alt="Preview {{ variantData.variant.width }}px"
                                                                class="card-img-top"
                                                                style="max-height: 150px; width: auto;"
                                                            />
                                                        </button>
                                                        <div class="card-body p-2 text-center">
                                                            <div class="fw-medium">{{ variantData.variant.width }}×{{ variantData.variant.height }}</div>
                                                            <div class="d-flex gap-1 justify-content-center mt-1">
                                                                {% for v in data.variants|filter(vv => vv.variant.width == variantData.variant.width) %}
                                                                    <span class="badge bg-{{ v.variant.format == 'avif' ? 'purple' : (v.variant.format == 'webp' ? 'blue' : 'orange') }}-lt">{{ v.variant.format|upper }}</span>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}
